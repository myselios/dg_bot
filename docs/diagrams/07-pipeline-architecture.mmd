flowchart TB
    subgraph Main["main.py - execute_trading_cycle()"]
        START((시작))
        SELECT{파이프라인 선택}
    end

    subgraph Pipelines["파이프라인 타입"]
        MULTI[create_multi_coin_trading_pipeline]
        ADAPTIVE[create_adaptive_trading_pipeline]
        BASIC[create_spot_trading_pipeline]
    end

    subgraph MultiCoinPipeline["멀티코인 파이프라인 (5 스테이지)"]
        M1[AdaptiveRiskCheckStage]
        M2[CoinScanStage]
        M3[DataCollectionStage]
        M4[AnalysisStage]
        M5[ExecutionStage]
    end

    subgraph AdaptivePipeline["적응형 파이프라인 (4 스테이지)"]
        A1[AdaptiveRiskCheckStage]
        A2[DataCollectionStage]
        A3[AnalysisStage]
        A4[ExecutionStage]
    end

    subgraph BasicPipeline["기본 파이프라인 (4 스테이지)"]
        B1[RiskCheckStage]
        B2[DataCollectionStage]
        B3[AnalysisStage]
        B4[ExecutionStage]
    end

    subgraph Context["PipelineContext"]
        CTX_BASE["기본 정보<br/>- ticker<br/>- trading_type<br/>- 서비스 인스턴스"]
        CTX_DATA["수집 데이터<br/>- chart_data<br/>- orderbook<br/>- technical_indicators"]
        CTX_ANALYSIS["분석 결과<br/>- ai_result<br/>- backtest_result<br/>- validation_result"]
        CTX_RISK["리스크 관리<br/>- risk_manager<br/>- position_check<br/>- circuit_check"]
    end

    subgraph StageResult["StageResult"]
        SR_SUCCESS["success: bool"]
        SR_ACTION["action: continue|skip|stop|exit"]
        SR_DATA["data: Dict"]
        SR_MESSAGE["message: str"]
    end

    START --> SELECT
    SELECT -->|use_multi_coin=True| MULTI
    SELECT -->|use_adaptive=True| ADAPTIVE
    SELECT -->|기본| BASIC

    MULTI --> M1
    M1 -->|continue| M2
    M2 -->|continue| M3
    M3 -->|continue| M4
    M4 -->|continue| M5

    ADAPTIVE --> A1
    A1 -->|continue| A2
    A2 -->|continue| A3
    A3 -->|continue| A4

    BASIC --> B1
    B1 -->|continue| B2
    B2 -->|continue| B3
    B3 -->|continue| B4

    M1 -.->|읽기/쓰기| CTX_BASE
    M2 -.->|읽기/쓰기| CTX_BASE
    M3 -.->|읽기/쓰기| CTX_DATA
    M4 -.->|읽기/쓰기| CTX_ANALYSIS
    M5 -.->|읽기| CTX_ANALYSIS

    style MULTI fill:#e1f5fe
    style ADAPTIVE fill:#fff3e0
    style BASIC fill:#f3e5f5

    style M1 fill:#bbdefb
    style M2 fill:#bbdefb
    style A1 fill:#ffe0b2
    style B1 fill:#e1bee7

