flowchart TB
    subgraph Main["main.py / scheduler_main.py - 듀얼 타임프레임"]
        START((시작))
        SELECT{사이클 타입}
    end

    subgraph Container["Container (DI)"]
        DI_CONTAINER[Container]
        DI_PORTS["Ports<br/>- ExchangePort<br/>- AIPort<br/>- IdempotencyPort<br/>- LockPort"]
        DI_USECASES["UseCases<br/>- ExecuteTradeUseCase<br/>- AnalyzeMarketUseCase<br/>- AnalyzeBreakoutUseCase"]
    end

    subgraph Cycles["사이클 타입"]
        TRADING["execute_trading_cycle()<br/>(매시 01분)"]
        POSITION["execute_position_management_cycle()<br/>(:01/:16/:31/:46)"]
    end

    subgraph Pipelines["파이프라인 타입"]
        HYBRID[create_hybrid_trading_pipeline]
        POSMGMT[create_position_management_pipeline]
    end

    subgraph HybridPipeline["하이브리드 파이프라인 (4 스테이지)"]
        H1[HybridRiskCheckStage<br/>리스크 체크 + 코인 스캔]
        H2[DataCollectionStage<br/>시장 데이터 수집]
        H3[AnalysisStage<br/>AI 분석 + 검증]
        H4[ExecutionStage<br/>거래 실행]
    end

    subgraph PositionPipeline["포지션 관리 파이프라인 (2 스테이지)"]
        P1[PositionCheckStage<br/>규칙 기반 체크]
        P2[PositionExecutionStage<br/>청산 실행]
    end

    subgraph Context["PipelineContext"]
        CTX_BASE["기본 정보<br/>- ticker<br/>- container (DI)<br/>- trading_type"]
        CTX_DATA["수집 데이터<br/>- chart_data<br/>- orderbook<br/>- technical_indicators"]
        CTX_ANALYSIS["분석 결과<br/>- ai_result<br/>- backtest_result<br/>- validation_result"]
        CTX_RISK["리스크 관리<br/>- risk_manager<br/>- position_check<br/>- circuit_check"]
    end

    subgraph StageResult["StageResult"]
        SR_SUCCESS["success: bool"]
        SR_ACTION["action: continue|skip|stop|exit"]
        SR_DATA["data: Dict"]
        SR_MESSAGE["message: str"]
    end

    subgraph CleanArch["Clean Architecture Layers"]
        DOMAIN["Domain Layer<br/>- Trade, Signal 엔티티<br/>- Money, Percentage 값객체<br/>- BreakoutFilter 서비스"]
        APP["Application Layer<br/>- UseCases<br/>- TradingOrchestrator<br/>- Ports 인터페이스"]
        INFRA["Infrastructure Layer<br/>- Adapters (Exchange, AI, DB)<br/>- PostgreSQL Lock/Idempotency"]
    end

    START --> DI_CONTAINER
    DI_CONTAINER --> DI_PORTS
    DI_CONTAINER --> DI_USECASES
    DI_CONTAINER --> SELECT

    SELECT -->|매시 01분| TRADING
    SELECT -->|15분 주기| POSITION

    TRADING --> HYBRID
    POSITION --> POSMGMT

    HYBRID --> H1
    H1 -->|continue| H2
    H2 -->|continue| H3
    H3 -->|continue| H4

    POSMGMT --> P1
    P1 -->|continue| P2

    H1 -.->|Container 사용| DI_USECASES
    H3 -.->|AnalyzeMarketUseCase| DI_USECASES
    H4 -.->|ExecuteTradeUseCase| DI_USECASES

    H1 -.->|읽기/쓰기| CTX_BASE
    H1 -.->|읽기/쓰기| CTX_RISK
    H2 -.->|읽기/쓰기| CTX_DATA
    H3 -.->|읽기/쓰기| CTX_ANALYSIS
    H4 -.->|읽기| CTX_ANALYSIS

    P1 -.->|읽기/쓰기| CTX_BASE
    P2 -.->|읽기| CTX_BASE

    DI_USECASES -.-> APP
    APP -.-> DOMAIN
    INFRA -.-> APP

    style TRADING fill:#e1f5fe
    style POSITION fill:#fff3e0

    style H1 fill:#bbdefb
    style H2 fill:#bbdefb
    style H3 fill:#bbdefb
    style H4 fill:#bbdefb
    style P1 fill:#ffe0b2
    style P2 fill:#ffe0b2

    style DOMAIN fill:#c8e6c9
    style APP fill:#c8e6c9
    style INFRA fill:#c8e6c9

    style DI_CONTAINER fill:#e1bee7
    style DI_PORTS fill:#e1bee7
    style DI_USECASES fill:#e1bee7

