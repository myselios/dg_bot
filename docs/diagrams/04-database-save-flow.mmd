sequenceDiagram
    participant BackendScheduler as Backend Scheduler<br/>(core/scheduler.py)
    participant Schema as Pydantic Schema<br/>(TradeCreate/AIDecisionCreate)
    participant API as Backend API<br/>(endpoints/trades.py)
    participant DB as PostgreSQL<br/>(trades/ai_decisions 테이블)
    participant Session as DB Session<br/>(get_db)

    Note over BackendScheduler: 거래 사이클 완료 후

    alt 거래 실행됨 (buy/sell) + trade_id 존재

        Note over BackendScheduler: 1. Trade 레코드 저장

        BackendScheduler->>Schema: TradeCreate 객체 생성
        Note over Schema: trade_id: str<br/>symbol: str<br/>side: "buy" | "sell"<br/>price: Decimal<br/>amount: Decimal<br/>total: Decimal<br/>fee: Decimal<br/>status: "completed"|"failed"

        BackendScheduler->>Session: async for db in get_db()
        Session-->>BackendScheduler: DB 세션

        BackendScheduler->>API: create_trade(trade_data, db)
        API->>API: Pydantic 자동 검증

        alt 검증 실패
            API-->>BackendScheduler: ValidationError
        end

        API->>DB: INSERT INTO trades
        DB->>DB: Commit Transaction

        alt 중복 거래 ID
            DB-->>API: IntegrityError
            API-->>BackendScheduler: "이미 존재하는 거래 ID"
        else 기타 DB 오류
            DB-->>API: DatabaseError
            API->>DB: Rollback
            API-->>BackendScheduler: 500 Internal Server Error
        end

        DB-->>API: Row Inserted
        API->>API: Refresh 객체
        API-->>BackendScheduler: TradeResponse

    end

    Note over BackendScheduler: 2. AI Decision 저장 (모든 결정)

    BackendScheduler->>Schema: AIDecisionCreate 객체 생성
    Note over Schema: symbol: str<br/>decision: "buy"|"sell"|"hold"<br/>confidence: Decimal (0-100)<br/>reason: str (max 500자)<br/>market_data: Dict (선택)

    BackendScheduler->>Session: async for db in get_db()
    Session-->>BackendScheduler: DB 세션

    BackendScheduler->>DB: AIDecision 모델 생성
    Note over DB: db_ai_decision = AIDecision(<br/>  **ai_decision_data.model_dump()<br/>)

    BackendScheduler->>DB: db.add(db_ai_decision)
    BackendScheduler->>DB: await db.commit()
    BackendScheduler->>DB: await db.refresh(db_ai_decision)

    alt DB 오류
        DB-->>BackendScheduler: Exception
        BackendScheduler->>DB: await db.rollback()
        BackendScheduler->>BackendScheduler: 에러 로깅
    else 성공
        DB-->>BackendScheduler: AI Decision 저장 완료
        BackendScheduler->>BackendScheduler: 로깅: "AI 판단 DB 저장 완료"
    end

    Note over BackendScheduler: 저장 완료 후 알림/메트릭 전송

