%% Position Management Job Flow
%% 15ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” position_management_jobì˜ ì „ì²´ íë¦„ (ê·œì¹™ ê¸°ë°˜ ì†ì ˆ/ìµì ˆ)

sequenceDiagram
    participant Scheduler as APScheduler
    participant PositionJob as position_management_job()
    participant Container
    participant LockPort
    participant TradingOrchestrator
    participant Telegram
    participant Prometheus

    Note over Scheduler: CronTrigger ë°œë™ (:01,:16,:31,:46)
    Scheduler->>PositionJob: ì‘ì—… ì‹¤í–‰

    Note over PositionJob: 1. Lock íšë“ (trading_cycle ê³µìœ )
    PositionJob->>Container: get_lock_port()
    PositionJob->>LockPort: acquire("trading_cycle", timeout=60)

    alt Lock íšë“ ì‹¤íŒ¨
        LockPort-->>PositionJob: False
        Note right of PositionJob: trading_jobì´ ì‹¤í–‰ ì¤‘
        PositionJob->>Prometheus: scheduler_job_success_total.inc()
        PositionJob-->>Scheduler: â­ï¸ ìŠ¤í‚µ (ì •ìƒ)
    end

    Note over PositionJob: 2. TradingOrchestrator ì´ˆê¸°í™”
    PositionJob->>Container: get_trading_orchestrator()
    Container-->>PositionJob: TradingOrchestrator

    Note over PositionJob: 3. í¬ì§€ì…˜ ê´€ë¦¬ ì‹¤í–‰
    PositionJob->>TradingOrchestrator: execute_position_management()
    Note right of TradingOrchestrator: ê·œì¹™ ê¸°ë°˜ ì†ì ˆ/ìµì ˆ<br/>(AI í˜¸ì¶œ ì—†ìŒ)
    TradingOrchestrator-->>PositionJob: result

    Note over PositionJob: 4. ê²°ê³¼ ì²˜ë¦¬
    alt status=success
        alt ì²­ì‚° ë°œìƒ
            Note over PositionJob: ğŸ“± ì²­ì‚° ì•Œë¦¼ (TODO)
        end
        PositionJob->>Prometheus: scheduler_job_success_total.inc()
    else status=skipped
        Note over PositionJob: í¬ì§€ì…˜ ì—†ìŒ
        PositionJob->>Prometheus: scheduler_job_success_total.inc()
    else status=failed
        PositionJob->>Telegram: notify_error(...)
        PositionJob->>Prometheus: scheduler_job_failure_total.inc()
    end

    PositionJob->>Prometheus: scheduler_job_duration_seconds.observe(duration)

    Note over PositionJob: 5. Lock í•´ì œ (finally)
    PositionJob->>LockPort: release("trading_cycle")
    PositionJob-->>Scheduler: âœ… ì‘ì—… ì™„ë£Œ
