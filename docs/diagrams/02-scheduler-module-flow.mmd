sequenceDiagram
    participant User as 사용자/시스템
    participant Scheduler as Scheduler<br/>(scheduler_main.py)
    participant APScheduler as APScheduler<br/>(AsyncIOScheduler)
    participant BackendScheduler as Backend Scheduler<br/>(core/scheduler.py)
    participant Container as Container<br/>(DI Container)
    participant Lock as LockPort<br/>(Advisory Lock)
    participant Idempotency as IdempotencyPort<br/>(중복 방지)
    participant DB as PostgreSQL<br/>(init_db)
    participant Metrics as Prometheus<br/>(metrics.py)
    participant Telegram as Telegram<br/>(notification.py)
    participant Logger as Logger

    User->>Scheduler: 애플리케이션 시작
    Scheduler->>Scheduler: load_dotenv()<br/>.env 파일 로드
    Scheduler->>Scheduler: validate_environment_variables()

    alt 환경변수 누락
        Note over Scheduler: 필수 환경변수:<br/>UPBIT_ACCESS_KEY<br/>UPBIT_SECRET_KEY<br/>DATABASE_URL<br/>OPENAI_API_KEY
        Scheduler->>Logger: ERROR 로그 기록
        Scheduler->>User: 프로그램 종료 (exit 1)
    end

    opt Sentry 활성화
        Scheduler->>Scheduler: sentry_sdk.init()<br/>(environment="scheduler")
    end

    Scheduler->>DB: init_db() 호출
    DB-->>Scheduler: 테이블 초기화 완료

    Scheduler->>Container: Container 초기화
    Container-->>Scheduler: Port/UseCase 준비 완료

    Scheduler->>Metrics: set_bot_running(True)
    Scheduler->>Telegram: notify_bot_status("started")

    Scheduler->>APScheduler: 스케줄러 생성<br/>AsyncIOScheduler()
    Note over APScheduler: 설정:<br/>timezone="Asia/Seoul"<br/>coalesce=True<br/>max_instances=1<br/>misfire_grace_time=60

    Scheduler->>APScheduler: add_jobs() - CronTrigger 사용
    Note over APScheduler: 등록된 작업:<br/>1. trading_job (매시 01분) - Lock+Idempotency<br/>2. position_management_job (:01/:16/:31/:46) - Lock<br/>3. portfolio_snapshot_job (매시 01분)<br/>4. daily_report_job (09:00)

    Scheduler->>APScheduler: start()
    APScheduler->>Logger: INFO: 스케줄러 시작됨
    Scheduler->>APScheduler: modify_job(next_run_time=now)<br/>(즉시 첫 실행)

    loop 매시 01분 (진입 탐색)
        APScheduler->>BackendScheduler: trading_job() 실행
        BackendScheduler->>Lock: acquire(LOCK_ID=1001)

        alt 락 획득 실패
            Lock-->>BackendScheduler: False (다른 작업 실행 중)
            BackendScheduler->>Logger: WARN: 락 획득 실패, 스킵
        else 락 획득 성공
            Lock-->>BackendScheduler: True
            BackendScheduler->>Logger: INFO: 트레이딩 작업 시작

            BackendScheduler->>Container: UseCase/Port 획득
            BackendScheduler->>Telegram: notify_cycle_start()

            BackendScheduler->>Idempotency: check_key(ticker-1h-candle_ts-buy)
            alt 이미 처리됨
                Idempotency-->>BackendScheduler: True (중복)
                BackendScheduler->>Logger: INFO: 중복 주문 방지
            else 미처리
                BackendScheduler->>BackendScheduler: execute_trading_cycle()
                Note over BackendScheduler: HybridRiskCheckStage:<br/>멀티코인 스캔 + 백테스팅 + AI 분석
                BackendScheduler->>Idempotency: mark_key(ticker-1h-candle_ts-buy)
                BackendScheduler->>Telegram: 5단계 알림 전송
            end

            BackendScheduler->>Metrics: 메트릭 기록
            BackendScheduler->>Lock: release(LOCK_ID=1001)
            BackendScheduler-->>APScheduler: 작업 완료
        end
        APScheduler->>Logger: INFO: 트레이딩 작업 완료
    end

    loop 매 15분 (:01/:16/:31/:46 - 포지션 관리)
        APScheduler->>BackendScheduler: position_management_job() 실행
        BackendScheduler->>Lock: acquire(LOCK_ID=1002)

        alt 락 획득 실패
            Lock-->>BackendScheduler: False
            BackendScheduler->>Logger: WARN: 락 획득 실패, 스킵
        else 락 획득 성공
            BackendScheduler->>Logger: INFO: 포지션 관리 작업 시작
            BackendScheduler->>BackendScheduler: 보유 포지션 손절/익절 체크
            Note over BackendScheduler: 규칙 기반 빠른 체크<br/>(AI 호출 없음)
            BackendScheduler->>Telegram: 포지션 변동 시 알림
            BackendScheduler->>Lock: release(LOCK_ID=1002)
            BackendScheduler-->>APScheduler: 작업 완료
        end
    end

    loop 매 시간 01분
        APScheduler->>BackendScheduler: portfolio_snapshot_job()
        BackendScheduler->>Logger: 포트폴리오 스냅샷 저장
    end

    loop 매일 09:00
        APScheduler->>BackendScheduler: daily_report_job()
        BackendScheduler->>Telegram: notify_daily_report()
    end

    User->>Scheduler: Ctrl+C (SIGINT/SIGTERM)
    Note over Scheduler: GracefulKiller 처리

    Scheduler->>Metrics: set_bot_running(False)
    Scheduler->>Telegram: notify_bot_status("stopped")
    Scheduler->>APScheduler: shutdown(wait=True)
    APScheduler->>Logger: INFO: 스케줄러 종료됨
    Scheduler->>User: 프로그램 정상 종료

