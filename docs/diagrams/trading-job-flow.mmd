%% Trading Job Flow (backend/app/core/scheduler.py â†’ trading_job)
%% 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” trading_jobì˜ ì „ì²´ íë¦„ (ë©€í‹°ì½”ì¸ ìŠ¤ìº” + AI ë¶„ì„ + ì§„ì…)

sequenceDiagram
    participant Scheduler as APScheduler
    participant TradingJob as trading_job()
    participant Container
    participant LockPort
    participant TradingOrchestrator
    participant IdempotencyPort
    participant Pipeline as HybridTradingPipeline
    participant Telegram
    participant DB as PostgreSQL
    participant Prometheus

    Note over Scheduler: CronTrigger ë°œë™ (ë§¤ì‹œ 01ë¶„)
    Scheduler->>TradingJob: ì‘ì—… ì‹¤í–‰

    Note over TradingJob: 1. Lock íšë“
    TradingJob->>Container: get_container()
    Container-->>TradingJob: Container ì¸ìŠ¤í„´ìŠ¤
    TradingJob->>Container: get_lock_port()
    Container-->>TradingJob: LockPort
    TradingJob->>LockPort: acquire("trading_cycle", timeout=600)

    alt Lock íšë“ ì‹¤íŒ¨
        LockPort-->>TradingJob: False (ë‹¤ë¥¸ ì‘ì—… ì‹¤í–‰ ì¤‘)
        TradingJob->>Prometheus: scheduler_job_failure_total.inc()
        TradingJob-->>Scheduler: âš ï¸ ë½ íšë“ ì‹¤íŒ¨ (ì¢…ë£Œ)
    end

    Note over TradingJob: 2. TradingOrchestrator ì´ˆê¸°í™”
    TradingJob->>Container: get_trading_orchestrator()
    Container-->>TradingJob: TradingOrchestrator

    Note over TradingJob: 3. í…”ë ˆê·¸ë¨ ì•Œë¦¼ #1 (ì‚¬ì´í´ ì‹œì‘)
    TradingJob->>Telegram: notify_cycle_start("ë©€í‹°ì½”ì¸ ìŠ¤ìºë‹ ì‹œì‘")

    Note over TradingJob: 4. ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ (ë¡œê¹…ìš©)
    TradingJob->>Container: get_upbit_client()
    TradingJob->>Container: get_data_collector()
    Note right of TradingJob: current_price, RSI, MA20, MA60 ë“±

    Note over TradingJob: 5. ë°±í…ŒìŠ¤íŒ… ì½œë°± ë“±ë¡
    TradingJob->>TradingOrchestrator: set_on_backtest_complete(callback)

    Note over TradingJob: 6. ê±°ë˜ ì‚¬ì´í´ ì‹¤í–‰ (10ë¶„ íƒ€ì„ì•„ì›ƒ)
    TradingJob->>TradingOrchestrator: execute_trading_cycle(ticker, enable_scanning=True)

    Note over TradingOrchestrator: 6.1 Idempotency ì²´í¬
    TradingOrchestrator->>Container: get_idempotency_port()
    Container-->>TradingOrchestrator: IdempotencyPort
    TradingOrchestrator->>TradingOrchestrator: _get_current_candle_ts()
    TradingOrchestrator->>TradingOrchestrator: make_idempotency_key(ticker, "1h", candle_ts, "trading_cycle")
    TradingOrchestrator->>IdempotencyPort: check_key(idempotency_key)

    alt ì¤‘ë³µ í‚¤ (ì´ë¯¸ ì‹¤í–‰ë¨)
        IdempotencyPort-->>TradingOrchestrator: True
        TradingOrchestrator-->>TradingJob: {'status': 'skipped', 'reason': 'Duplicate key'}
        TradingJob->>Prometheus: scheduler_job_success_total.inc()
        TradingJob->>LockPort: release("trading_cycle")
        TradingJob-->>Scheduler: â­ï¸ ìŠ¤í‚µ (ì •ìƒ ì¢…ë£Œ)
    end

    alt Idempotency ì²´í¬ ì‹¤íŒ¨
        IdempotencyPort-->>TradingOrchestrator: Exception
        TradingOrchestrator-->>TradingJob: {'status': 'blocked', 'error': 'Idempotency check failed'}
        TradingJob->>Prometheus: scheduler_job_failure_total.inc()
        TradingJob->>LockPort: release("trading_cycle")
        TradingJob-->>Scheduler: â›” ê±°ë˜ ì°¨ë‹¨ (fail-close)
    end

    Note over TradingOrchestrator: 6.2 í•˜ì´ë¸Œë¦¬ë“œ íŒŒì´í”„ë¼ì¸ ìƒì„±
    TradingOrchestrator->>TradingOrchestrator: create_hybrid_trading_pipeline(...)
    Note right of TradingOrchestrator: 4ë‹¨ê³„ íŒŒì´í”„ë¼ì¸:<br/>1. HybridRiskCheckStage<br/>2. DataCollectionStage<br/>3. AnalysisStage<br/>4. ExecutionStage

    Note over TradingOrchestrator: 6.3 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
    TradingOrchestrator->>Pipeline: execute(context)

    Note over Pipeline: Stage 1: HybridRiskCheckStage
    Pipeline->>Pipeline: í¬ì§€ì…˜ í™•ì¸ + ë©€í‹°ì½”ì¸ ìŠ¤ìº”
    alt enable_scanning=True
        Pipeline->>Pipeline: CoinSelector.scan_liquidity()
        Pipeline->>Pipeline: MultiBacktest.run_multi_backtest()
        Pipeline->>Pipeline: ë°±í…ŒìŠ¤íŒ… ì½œë°± í˜¸ì¶œ
        Pipeline->>TradingJob: on_backtest_complete_callback(backtest_data)
        Note over TradingJob: ğŸ“± ì•Œë¦¼ #2: ìŠ¤ìº” ê²°ê³¼ + ë°±í…ŒìŠ¤íŒ…
        TradingJob->>Telegram: notify_scan_result(scan_summary, selected_coin, all_backtest_results)
    end

    Note over Pipeline: Stage 2: DataCollectionStage
    Pipeline->>Pipeline: ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘

    Note over Pipeline: Stage 3: AnalysisStage
    Pipeline->>Pipeline: ê¸°ìˆ ì  ë¶„ì„ + AI ë¶„ì„
    Note right of Pipeline: Quick Filter â†’ (í†µê³¼ ì‹œ) AI í˜¸ì¶œ

    Note over Pipeline: Stage 4: ExecutionStage
    Pipeline->>Pipeline: ê±°ë˜ ì‹¤í–‰ (buy/sell/hold)
    Pipeline-->>TradingOrchestrator: result

    Note over TradingOrchestrator: 6.4 Idempotency í‚¤ ë§ˆí‚¹
    alt status=success or skipped
        TradingOrchestrator->>IdempotencyPort: mark_key(idempotency_key, ttl_hours=24)
    end

    TradingOrchestrator-->>TradingJob: result

    Note over TradingJob: 7. ê²°ê³¼ ì²˜ë¦¬
    alt status=success
        Note over TradingJob: 7.1 ë©”íŠ¸ë¦­ ê¸°ë¡
        TradingJob->>Prometheus: record_ai_decision(symbol, decision, confidence)
        TradingJob->>DB: AIDecisionCreate ì €ì¥

        alt decision=buy or sell
            TradingJob->>Prometheus: record_trade(symbol, side, volume, fee)
            TradingJob->>DB: TradeCreate ì €ì¥
        end

        Note over TradingJob: 7.2 í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ ìˆ˜ì§‘
        TradingJob->>Container: get_upbit_client()
        Note right of TradingJob: KRW ì”ê³  + ì•”í˜¸í™”í ì”ê³ 

        Note over TradingJob: ğŸ“± ì•Œë¦¼ #3: AI ì˜ì‚¬ê²°ì • ìƒì„¸
        TradingJob->>Telegram: notify_ai_decision(symbol, decision, confidence, reason, duration)

        Note over TradingJob: ğŸ“± ì•Œë¦¼ #4: í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©
        TradingJob->>Telegram: notify_portfolio_status(symbol, portfolio_data, trade_result)

        TradingJob->>Prometheus: scheduler_job_success_total.inc()
        TradingJob->>Prometheus: scheduler_job_duration_seconds.observe(duration)

    else status=skipped
        Note over TradingJob: Idempotency ìŠ¤í‚µ (ì •ìƒ)
        TradingJob->>Prometheus: scheduler_job_success_total.inc()

    else status=failed
        Note over TradingJob: ì—ëŸ¬ ì²˜ë¦¬
        TradingJob->>Telegram: notify_error(error_type, error_message, context)
        TradingJob->>Prometheus: scheduler_job_failure_total.inc()
    end

    Note over TradingJob: 8. Lock í•´ì œ (finally)
    TradingJob->>LockPort: release("trading_cycle")
    TradingJob-->>Scheduler: âœ… ì‘ì—… ì™„ë£Œ
