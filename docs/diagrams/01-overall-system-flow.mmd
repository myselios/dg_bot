sequenceDiagram
    participant Scheduler as 스케줄러<br/>(scheduler_main.py)
    participant BackendScheduler as Backend Scheduler<br/>(core/scheduler.py)
    participant Main as main.py<br/>(거래 사이클)
    participant Pipeline as TradingPipeline<br/>(파이프라인 오케스트레이터)
    participant Stages as Pipeline Stages<br/>(스테이지들)
    participant Upbit as Upbit API<br/>(거래소)
    participant DB as PostgreSQL<br/>(trades 테이블)
    participant Telegram as Telegram<br/>(알림)
    participant Metrics as Prometheus<br/>(메트릭)

    Note over Scheduler,BackendScheduler: 듀얼 타임프레임 스케줄러

    par 매 1시간: 진입 탐색
        Scheduler->>BackendScheduler: trading_job() 실행
        BackendScheduler->>Main: execute_trading_cycle() 호출
    and 매 15분: 포지션 관리
        Scheduler->>BackendScheduler: position_management_job() 실행
        BackendScheduler->>Main: execute_position_management_cycle() 호출
    end

    Note over Main: 하이브리드 파이프라인 선택:<br/>- create_hybrid_trading_pipeline()<br/>- create_position_management_pipeline()

    Main->>Pipeline: create_*_trading_pipeline()
    Main->>Pipeline: pipeline.execute(context)

    Note over Pipeline,Stages: 스테이지 순차 실행

    alt 멀티코인 파이프라인
        Pipeline->>Stages: 1. AdaptiveRiskCheckStage
        Stages->>Upbit: 포트폴리오 조회
        Upbit-->>Stages: 포지션 정보

        Pipeline->>Stages: 2. CoinScanStage (ENTRY 모드)
        Note over Stages: 유동성 스캔 → 백테스팅<br/>→ 최적 코인 선택

        Pipeline->>Stages: 3. DataCollectionStage
        Stages->>Upbit: 차트/오더북 데이터
        Upbit-->>Stages: OHLCV, 호가

        Pipeline->>Stages: 4. AnalysisStage
        Note over Stages: 기술적 분석 + AI 진입 분석

        Pipeline->>Stages: 5. ExecutionStage
        Stages->>Upbit: 매수/매도 주문
        Upbit-->>Stages: 주문 결과
    else 적응형 파이프라인
        Pipeline->>Stages: 1. AdaptiveRiskCheckStage
        Note over Stages: ENTRY/MANAGEMENT 모드 분기

        alt 포지션 있음 (MANAGEMENT)
            Stages->>Stages: 규칙 기반 청산 체크<br/>(손절/익절/Fakeout)
            opt 애매한 상황
                Stages->>Stages: AI 포지션 분석
            end
        else 포지션 없음 (ENTRY)
            Pipeline->>Stages: 2. DataCollectionStage
            Pipeline->>Stages: 3. AnalysisStage
            Pipeline->>Stages: 4. ExecutionStage
        end
    end

    Pipeline-->>Main: 실행 결과 반환
    Main-->>BackendScheduler: result 반환

    alt 거래 성공 (buy 또는 sell)
        BackendScheduler->>DB: Trade/AIDecision 저장
        DB-->>BackendScheduler: 저장 완료
        BackendScheduler->>Metrics: record_trade() / record_ai_decision()
        BackendScheduler->>Telegram: 4단계 알림 전송
        Note over Telegram: 1. 사이클 시작<br/>2. 백테스팅/신호<br/>3. AI 의사결정<br/>4. 포트폴리오 현황
    else 거래 실패 또는 hold
        BackendScheduler->>Metrics: AI 판단만 기록
        BackendScheduler->>Telegram: 에러 알림 (실패 시)
    end

